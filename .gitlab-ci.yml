image: eclipse-temurin:21-jdk

stages:
  - build
  - test


variables:
  SPRING_PROFILES_ACTIVE: ci
  MYSQL_URL: jdbc:mysql://mysql:3306/testdb
  MYSQL_USER: testuser
  MYSQL_PASSWORD: testpass
  AWS_ACCESS_KEY: $AWS_ACCESS_KEY
  AWS_SECRET_KEY: $AWS_SECRET_KEY
  AWS_REGION: ap-northeast-2

cache:
  paths:
    - .gradle/caches/
    - .gradle/wrapper/

services:
  - name: mysql:8.0
    alias: mysql

before_script:
  - echo "Waiting for MySQL to be ready..."
  - for i in {1..10}; do mysqladmin ping -hmysql -ptestpass && break || sleep 5; done
  - chmod +x ./gradlew

build:
  stage: build
  environment:
    name: CICD
  script:
    - ./gradlew clean build -x test
 

test:
  stage: test
  script:
    - ./gradlew test
