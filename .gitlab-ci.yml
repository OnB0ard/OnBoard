stages: [build-fe, deploy-fe]

variables:
  FE_BUILD_DIR: dist
  DEPLOY_PATH: /var/www/html
  TZ: Asia/Seoul

# ê°™ì€ ë¦¬ì†ŒìŠ¤(í”„ë¡ íŠ¸ ë°°í¬) ì§ë ¬í™”í•´ì„œ ê²½í•© ë°©ì§€
resource_group: fe-deploy

cache:
  paths:
    - frontend/node_modules/

build-fe:
  stage: build-fe
  tags: [fe-docker]
  image: node:20
  script:
    - cd frontend
    - printenv | grep ^VITE_ > .env.production
    - npm ci || npm install
    - npm run build
  artifacts:
    paths:
      - frontend/$FE_BUILD_DIR
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop-FE"'
      when: always

deploy-fe:
  stage: deploy-fe
  tags: [fe-docker]
  needs: ["build-fe"]
  image: debian:stable-slim
  before_script:
    - apt-get update
    - apt-get install -y openssh-client rsync ca-certificates curl

    - echo "$SSH_PRIVATE_KEY" > private_key.pem
    - chmod 600 private_key.pem
    - export SSHPARAMS="-i private_key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

    - '[ -n "$SSH_USER" ] && [ -n "$SSH_HOST" ] || { echo "SSH_USER/SSH_HOST not set"; exit 1; }'
  script:
    - test -d frontend/$FE_BUILD_DIR || { echo "âŒ frontend/$FE_BUILD_DIR not found"; exit 1; }

    # ì›ê²©: ì‚¬ì „ ê°€ë“œ(í˜„ì¬ ì„¤ì •ì´ SPA fallbackì¸ì§€, =404 í™œì„± ë¼ì¸ ì—†ëŠ”ì§€ ì§„ë‹¨)
    - |
      ssh $SSHPARAMS $SSH_USER@$SSH_HOST bash -s <<'REMOTE'
      set -euo pipefail

      echo "ğŸ” Pre-check: Nginx effective config"
      sudo nginx -t >/dev/null

      # =404 í™œì„± ë¼ì¸(ì£¼ì„ ì œì™¸) íƒì§€
      if sudo nginx -T 2>/dev/null | awk '/try_files/ && $0 !~ /^[[:space:]]*#/ && $0 ~ /=404;/{bad=1} END{exit bad?0:1}'; then
        echo "âŒ Detected active 'try_files ... =404;' somewhere in effective config"
        echo "---- Hints (first 200 lines around matches) ----"
        sudo nginx -T 2>/dev/null | nl -ba | awk 'p&&c<200{print; c++} /try_files[[:space:]]+\$uri[[:space:]]+\$uri\/.*=404;/{p=1;c=0}'; echo "-----------------------------------------------"
        exit 1
      fi

      # SPA fallback ì¡´ì¬ í™•ì¸
      if ! sudo nginx -T 2>/dev/null | grep -q 'try_files \$uri \$uri/ /index.html'; then
        echo "âŒ SPA fallback(try_files ... /index.html) not found in effective config"
        echo "Tip: ensure sites-enabled/default (or active server) has 'location / { try_files \$uri \$uri/ /index.html; }'"
        exit 1
      fi

      # include/í™œì„± ì‚¬ì´íŠ¸ êµ¬ì¡°ë„ ê°„ë‹¨ ì¶œë ¥
      echo "ğŸ§­ Active site links:"
      ls -l /etc/nginx/sites-enabled || true
      echo "ğŸ—‚  conf.d listing:"
      ls -l /etc/nginx/conf.d || true
      REMOTE

    # ì—…ë¡œë“œ
    - ssh $SSHPARAMS $SSH_USER@$SSH_HOST 'mkdir -p ~/front-build /var/www/releases'
    - rsync -az --delete -e "ssh $SSHPARAMS" frontend/$FE_BUILD_DIR/ $SSH_USER@$SSH_HOST:/home/ubuntu/front-build/

    # ì›ê²© ë°°í¬ + ì‚¬í›„ ê°€ë“œ/ì›ì¸ ì§„ë‹¨
    - |
      ssh $SSHPARAMS $SSH_USER@$SSH_HOST "DEPLOY_PATH='$DEPLOY_PATH'" bash -s <<'REMOTE'
      set -euo pipefail

      TS=$(date +%Y%m%d%H%M%S)
      TARGET="/var/www/releases/$TS"

      echo "ğŸšš Sync to release: $TARGET"
      sudo mkdir -p "$TARGET"
      sudo rsync -a --delete /home/ubuntu/front-build/ "$TARGET"/

      # ì‚°ì¶œë¬¼ sanity check
      if ! sudo test -f "$TARGET/index.html"; then
        echo "âŒ Missing $TARGET/index.html (build artifact problem)"; exit 1
      fi
      echo "âœ… index.html present in release"

      # ê¶Œí•œ ì •ë¦¬
      sudo find "$TARGET" -type d -exec chmod 755 {} \;
      sudo find "$TARGET" -type f -exec chmod 644 {} \;

      # ì‹¬ë§í¬ ìŠ¤ìœ„ì¹˜(ì›ìì )
      sudo ln -sfnT "$TARGET" "$DEPLOY_PATH"

      # ë¦´ë¦¬ì¦ˆ í´ë” ì •ë¦¬ (ìµœì‹  5ê°œ ìœ ì§€)
      sudo bash -lc 'cd /var/www/releases && ls -1dt */ 2>/dev/null | tail -n +6 | xargs -r rm -rf'

      # Nginx ì¬ê²€ì¦ & reload
      sudo nginx -t && sudo systemctl reload nginx

      echo "ğŸ” Post-check: SPA fallback & index served"
      # íš¨ê³¼ì  ì„¤ì •ì— SPA fallback ìœ ì§€ë˜ëŠ”ì§€
      if ! sudo nginx -T 2>/dev/null | grep -q 'try_files \$uri \$uri/ /index.html'; then
        echo "âŒ After reload, SPA fallback missing â€” config changed unexpectedly."
        exit 1
      fi

      # í˜„ì¬ ì‹¬ë§í¬/ì¸ë±ìŠ¤ í™•ì¸
      echo -n "ğŸ”— DEPLOY_PATH -> "; readlink -f "$DEPLOY_PATH" || true
      sudo test -f "$DEPLOY_PATH/index.html" || { echo "âŒ No index at DEPLOY_PATH"; exit 1; }

      # ë¡œì»¬í—¬ìŠ¤: ë£¨íŠ¸ ìš”ì²­ 200 í™•ì¸(ë³¸ë¬¸ ê¸¸ì´ì™€ í—¤ë”)
      set +e
      HDRS=$(curl -sI http://127.0.0.1/ || true)
      CODE=$(printf "%s" "$HDRS" | awk 'NR==1{print $2}')
      set -e
      echo "ğŸŒ curl HEAD / -> $CODE"
      if [ "${CODE:-}" != "200" ]; then
        echo "âš ï¸  HEAD not 200. Dumping small diagnostics:"
        echo "---- server_name ----"; sudo nginx -T 2>/dev/null | grep -E 'server_name|listen 80' -n | sed -n '1,50p'
        echo "---- access/error tail ----"; sudo tail -n 50 /var/log/nginx/access.log 2>/dev/null || true; sudo tail -n 50 /var/log/nginx/error.log 2>/dev/null || true
        exit 1
      fi

      echo "âœ… Deployed OK"
      REMOTE
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop-FE"'
      when: always