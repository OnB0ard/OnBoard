image: docker:24.0.7

services: [] # ❌ docker:dind 제거

stages:
  - build
  - deploy

variables:
  DOCKER_HOST: "unix:///var/run/docker.sock"
  SPRING_PROFILES_ACTIVE: deploy
  MYSQL_URL: $MYSQL_URL
  MYSQL_USER: $MYSQL_USER
  MYSQL_PASSWORD: testpass
  AWS_ACCESS_KEY: $AWS_ACCESS_KEY
  AWS_SECRET_KEY: $AWS_SECRET_KEY
  AWS_REGION: ap-northeast-2
  AWS_S3_BUCKET: $AWS_S3_BUCKET
  JWT_ACCESS_TOKEN_EXPIRATION: 60
  JWT_REFRESH_TOKEN_EXPIRATION: 604800
  JWT_SECRET: $JWT_SECRET
  DEPLOY_DIR: /home/ubuntu/deploy
  JAR_NAME: backend-0.0.1-SNAPSHOT.jar
  TZ: Asia/Seoul
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

cache:
  paths:
    - .gradle/caches/
    - .gradle/wrapper/

build:
  stage: build
  tags:
    - build
  script:
    - cd backend
    - chmod +x ./gradlew
    - ./gradlew clean build -x test -Dspring.profiles.active=deploy
    - sudo docker build -t tripwith:latest .
  artifacts:
    paths:
      - backend/build/libs/
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop-BE" || $CI_COMMIT_BRANCH == "feat/docker-cicd"'
      when: always

deploy:
  stage: deploy
  tags:
    - deploy
  script:
    - echo "SPRING_PROFILES_ACTIVE=deploy" > ./backend/.deploy/docker/.env
    - echo "MYSQL_URL=$MYSQL_URL" >> ./backend/.deploy/docker/.env
    - echo "MYSQL_USER=$MYSQL_USER" >> ./backend/.deploy/docker/.env
    - echo "MYSQL_PASSWORD=$MYSQL_PASSWORD" >> ./backend/.deploy/docker/.env
    - echo "AWS_ACCESS_KEY=$AWS_ACCESS_KEY" >> ./backend/.deploy/docker/.env
    - echo "AWS_SECRET_KEY=$AWS_SECRET_KEY" >> ./backend/.deploy/docker/.env
    - echo "AWS_REGION=ap-northeast-2" >> ./backend/.deploy/docker/.env
    - echo "AWS_S3_BUCKET=$AWS_S3_BUCKET" >> ./backend/.deploy/docker/.env
    - echo "JWT_ACCESS_TOKEN_EXPIRATION=60" >> ./backend/.deploy/docker/.env
    - echo "JWT_REFRESH_TOKEN_EXPIRATION=604800" >> ./backend/.deploy/docker/.env
    - echo "JWT_SECRET=$JWT_SECRET" >> ./backend/.deploy/docker/.env
    - chmod +x ./backend/.deploy/deploy.sh
    - sudo ./backend/.deploy/deploy.sh
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop-BE" || $CI_COMMIT_BRANCH == "feat/docker-cicd"'
      when: always
